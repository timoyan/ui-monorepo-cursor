name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
permissions:
  contents: read
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.56.1-jammy
    env:
      HOME: /root
      PLAYWRIGHT_BROWSERS_PATH: /root/.cache/ms-playwright
    steps:
    - uses: actions/checkout@v6
    
    - uses: pnpm/action-setup@v4
      with:
        version: latest
    
    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ~/.pnpm-store
        key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-
    
    - name: Cache node_modules
      uses: actions/cache@v4
      with:
        path: |
          node_modules
          packages/*/node_modules
        key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-node-modules-
    
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    
    - name: Cache Playwright browsers
      uses: actions/cache@v4
      with:
        path: /root/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-playwright-
    
    - name: Cache ui-react18 build
      uses: actions/cache@v4
      id: cache-ui-react18
      with:
        path: packages/ui-react18/build
        key: ${{ runner.os }}-ui-react18-${{ hashFiles('packages/ui-react18/**/*.{ts,tsx,js,jsx,json}') }}
        restore-keys: |
          ${{ runner.os }}-ui-react18-
    
    - name: Cache ui-react19 build
      uses: actions/cache@v4
      id: cache-ui-react19
      with:
        path: packages/ui-react19/build
        key: ${{ runner.os }}-ui-react19-${{ hashFiles('packages/ui-react19/**/*.{ts,tsx,js,jsx,json}') }}
        restore-keys: |
          ${{ runner.os }}-ui-react19-
    
    - name: Build ui-react18
      if: steps.cache-ui-react18.outputs.cache-hit != 'true'
      run: cd packages/ui-react18 && pnpm build
    
    - name: Build ui-react19
      if: steps.cache-ui-react19.outputs.cache-hit != 'true'
      run: cd packages/ui-react19 && pnpm build
    
    - name: Install Playwright browsers
      run: pnpm exec playwright install --with-deps
    
    - name: Run Playwright tests
      run: pnpm exec playwright test
    
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

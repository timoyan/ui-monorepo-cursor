# Module Library SSR æ”¯æŒèªªæ˜

## æ¦‚è¿°

**module-library çš„ Stencil Web Components ç†è«–ä¸Šå¯ä»¥æ”¯æŒ SSR**ï¼Œä½†éœ€è¦æ­£ç¢ºçš„é…ç½®ã€‚ç•¶å‰å¯¦ç¾ä½¿ç”¨ `ssr: false` ä¾†é¿å… hydration è­¦å‘Šï¼Œé€™æ˜¯ä¸€å€‹å¯¦ç”¨çš„è§£æ±ºæ–¹æ¡ˆï¼Œä½†ä¸æ˜¯å”¯ä¸€é¸æ“‡ã€‚

## SSR æ”¯æŒæƒ…æ³

### âœ… ç†è«–ä¸Šæ”¯æŒ SSR

Stencil Web Components å¯ä»¥æ”¯æŒ SSRï¼Œå› ç‚ºï¼š
- Stencil çµ„ä»¶æœ€çµ‚æ¸²æŸ“ç‚ºæ¨™æº– HTML
- ä½¿ç”¨ Scoped CSSï¼ˆè€Œé Shadow DOMï¼‰æ›´å®¹æ˜“åœ¨ SSR ä¸­è™•ç†
- React Output Target ç”Ÿæˆçš„åŒ…è£çµ„ä»¶å¯ä»¥åœ¨ SSR ç’°å¢ƒä¸­å·¥ä½œ

### âš ï¸ å¯¦éš›æŒ‘æˆ°

ä½†åœ¨ Next.js SSR ä¸­æœƒé‡åˆ°ï¼š

1. **Hydration ä¸åŒ¹é…**
   - æœå‹™å™¨ç«¯æ¸²æŸ“çš„ HTML èˆ‡å®¢æˆ¶ç«¯åˆå§‹åŒ–çš„ Web Components å¯èƒ½ä¸ä¸€è‡´
   - React æœƒæª¢æ¸¬åˆ°å·®ç•°ä¸¦ç™¼å‡ºè­¦å‘Š

2. **çµ„ä»¶åˆå§‹åŒ–æ™‚æ©Ÿ**
   - Web Components éœ€è¦åœ¨å®¢æˆ¶ç«¯å®šç¾©ï¼ˆ`defineCustomElements`ï¼‰
   - SSR æ™‚çµ„ä»¶å°šæœªå®šç¾©ï¼Œå¯èƒ½å°è‡´å±¬æ€§è™•ç†ä¸æ­£ç¢º

3. **äº‹ä»¶ç¶å®š**
   - SSR ç”Ÿæˆçš„éœæ…‹ HTML ç„¡æ³•ç¶å®šäº‹ä»¶
   - éœ€è¦åœ¨å®¢æˆ¶ç«¯ hydration æ™‚é‡æ–°ç¶å®š

## ç•¶å‰è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šç¦ç”¨ SSRï¼ˆç•¶å‰ä½¿ç”¨ï¼‰

```tsx
import dynamic from "next/dynamic";

const MyButton = dynamic(
  () => import("module-library/react").then((mod) => ({ default: mod.MyButton })),
  {
    ssr: false,  // ç¦ç”¨æœå‹™å™¨ç«¯æ¸²æŸ“
  }
);
```

**å„ªé»ï¼š**
- âœ… ç°¡å–®ç›´æ¥ï¼Œç„¡ hydration è­¦å‘Š
- âœ… çµ„ä»¶åœ¨å®¢æˆ¶ç«¯æ­£ç¢ºåˆå§‹åŒ–
- âœ… äº‹ä»¶è™•ç†æ­£å¸¸å·¥ä½œ

**ç¼ºé»ï¼š**
- âŒ å½±éŸ¿ SEOï¼ˆçµ„ä»¶å…§å®¹ä¸æœƒå‡ºç¾åœ¨åˆå§‹ HTML ä¸­ï¼‰
- âŒ é¦–æ¬¡è¼‰å…¥å¯èƒ½æœƒæœ‰è¼•å¾®å»¶é²
- âŒ ç„¡æ³•åˆ©ç”¨ SSR çš„æ€§èƒ½å„ªå‹¢

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ `suppressHydrationWarning`ï¼ˆä¸æ¨è–¦ï¼‰

```tsx
<MyButton suppressHydrationWarning>
  Click me
</MyButton>
```

**å„ªé»ï¼š**
- âœ… ä¿æŒ SSR
- âœ… éš±è—è­¦å‘Š

**ç¼ºé»ï¼š**
- âŒ åªæ˜¯éš±è—è­¦å‘Šï¼Œä¸è§£æ±ºæ ¹æœ¬å•é¡Œ
- âŒ å¯èƒ½å°è‡´å¯¦éš›çš„æ¸²æŸ“ä¸ä¸€è‡´

### æ–¹æ¡ˆ 3ï¼šå®Œæ•´ SSR æ”¯æŒï¼ˆéœ€è¦é¡å¤–é…ç½®ï¼‰

è¦å¯¦ç¾å®Œæ•´çš„ SSR æ”¯æŒï¼Œéœ€è¦ï¼š

#### 3.1 ç¢ºä¿çµ„ä»¶åœ¨ SSR æ™‚æ­£ç¢ºæ¸²æŸ“

```tsx
// pages/_app.tsx
import { useEffect } from "react";
import { defineCustomElements } from "module-library/loader";

export default function App({ Component, pageProps }) {
  useEffect(() => {
    // åœ¨å®¢æˆ¶ç«¯å®šç¾©è‡ªå®šç¾©å…ƒç´ 
    defineCustomElements();
  }, []);

  return <Component {...pageProps} />;
}
```

#### 3.2 ä½¿ç”¨ `suppressHydrationWarning` è™•ç†å·²çŸ¥å·®ç•°

```tsx
// å°æ–¼å·²çŸ¥çš„ SSR/CSR å·®ç•°ï¼Œä½¿ç”¨ suppressHydrationWarning
<MyButton suppressHydrationWarning variant="primary">
  Click me
</MyButton>
```

#### 3.3 é…ç½® Next.js è™•ç† Web Components

```javascript
// next.config.js
module.exports = {
  transpilePackages: ["module-library"],
  // ç¢ºä¿ Web Components åœ¨ SSR æ™‚æ­£ç¢ºè™•ç†
  webpack: (config) => {
    // å¯èƒ½éœ€è¦é¡å¤–é…ç½®
    return config;
  },
};
```

## æ¨è–¦æ–¹æ¡ˆ

### å°æ–¼å¤§å¤šæ•¸æƒ…æ³ï¼šä½¿ç”¨ `ssr: false`

å¦‚æœï¼š
- âœ… SEO ä¸æ˜¯ä¸»è¦è€ƒæ…®å› ç´ ï¼ˆçµ„ä»¶ä¸»è¦æ˜¯äº¤äº’å¼ UIï¼‰
- âœ… å¸Œæœ›ç°¡å–®å¿«é€Ÿçš„è§£æ±ºæ–¹æ¡ˆ
- âœ… å¯ä»¥æ¥å—è¼•å¾®çš„é¦–æ¬¡è¼‰å…¥å»¶é²

**æ¨è–¦ä½¿ç”¨ç•¶å‰çš„ `dynamic` + `ssr: false` æ–¹æ¡ˆã€‚**

### å°æ–¼éœ€è¦ SEO çš„æƒ…æ³ï¼šå¯¦ç¾å®Œæ•´ SSR

å¦‚æœï¼š
- âš ï¸ çµ„ä»¶å…§å®¹å° SEO å¾ˆé‡è¦
- âš ï¸ éœ€è¦å®Œæ•´çš„ SSR æ€§èƒ½å„ªå‹¢
- âš ï¸ é¡˜æ„æŠ•å…¥æ™‚é–“é…ç½®

**éœ€è¦å¯¦ç¾å®Œæ•´çš„ SSR æ”¯æŒã€‚**

## å¯¦éš›å»ºè­°

### ç•¶å‰å°ˆæ¡ˆå»ºè­°

**ä¿æŒä½¿ç”¨ `ssr: false`**ï¼Œå› ç‚ºï¼š

1. **çµ„ä»¶ç‰¹æ€§**
   - `MyButton` æ˜¯äº¤äº’å¼çµ„ä»¶ï¼Œå…§å®¹å° SEO å½±éŸ¿ä¸å¤§
   - æŒ‰éˆ•æ–‡å­—é€šå¸¸å·²ç¶“åœ¨é é¢å…¶ä»–åœ°æ–¹å‡ºç¾

2. **é–‹ç™¼æ•ˆç‡**
   - ç•¶å‰æ–¹æ¡ˆç°¡å–®æœ‰æ•ˆ
   - ç„¡éœ€é¡å¤–é…ç½®å’Œèª¿è©¦

3. **æœªä¾†æ“´å±•**
   - å¦‚æœæœªä¾†éœ€è¦ SSRï¼Œå¯ä»¥é€æ­¥é·ç§»
   - ä¸å½±éŸ¿å…¶ä»–çµ„ä»¶çš„é–‹ç™¼

### ä½•æ™‚éœ€è¦å®Œæ•´ SSRï¼Ÿ

è€ƒæ…®å¯¦ç¾å®Œæ•´ SSR æ”¯æŒï¼Œå¦‚æœï¼š

- ğŸ“„ çµ„ä»¶åŒ…å«é‡è¦çš„æ–‡æœ¬å…§å®¹ï¼ˆå¦‚æ–‡ç« ã€æè¿°ï¼‰
- ğŸ” SEO æ˜¯é—œéµéœ€æ±‚
- âš¡ éœ€è¦æœ€å¤§åŒ–é¦–æ¬¡è¼‰å…¥æ€§èƒ½
- ğŸ¯ çµ„ä»¶æ˜¯é é¢çš„æ ¸å¿ƒå…§å®¹ï¼ˆè€Œéè£é£¾æ€§ UIï¼‰

## çµ„ä»¶ç´šåˆ¥çš„ SSR æ§åˆ¶

å¯ä»¥æ ¹æ“šçµ„ä»¶é¡å‹é¸æ“‡ä¸åŒçš„ç­–ç•¥ï¼š

```tsx
// äº¤äº’å¼çµ„ä»¶ï¼šç¦ç”¨ SSR
const MyButton = dynamic(
  () => import("module-library/react").then((mod) => ({ default: mod.MyButton })),
  { ssr: false }
);

// å…§å®¹çµ„ä»¶ï¼šå•Ÿç”¨ SSRï¼ˆå¦‚æœå¯¦ç¾äº†å®Œæ•´æ”¯æŒï¼‰
const MyCard = dynamic(
  () => import("module-library/react").then((mod) => ({ default: mod.MyCard })),
  { ssr: true }  // éœ€è¦é¡å¤–é…ç½®
);
```

## ç¸½çµ

| æ–¹æ¡ˆ | SSR æ”¯æŒ | SEO å‹å¥½ | è¤‡é›œåº¦ | æ¨è–¦å ´æ™¯ |
|------|---------|---------|--------|---------|
| `ssr: false` | âŒ | âŒ | ä½ | äº¤äº’å¼çµ„ä»¶ï¼ˆç•¶å‰æ–¹æ¡ˆï¼‰ |
| `suppressHydrationWarning` | âœ… | âœ… | ä¸­ | ä¸æ¨è–¦ |
| å®Œæ•´ SSR é…ç½® | âœ… | âœ… | é«˜ | å…§å®¹å‹çµ„ä»¶ã€SEO é—œéµ |

**ç•¶å‰å»ºè­°ï¼šç¹¼çºŒä½¿ç”¨ `ssr: false`ï¼Œé™¤éæœ‰æ˜ç¢ºçš„ SEO æˆ–æ€§èƒ½éœ€æ±‚ã€‚**

